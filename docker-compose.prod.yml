# Halo - Production Docker Compose
# Sử dụng pre-built images từ GitHub Container Registry
# Tối ưu cho môi trường production

version: "3.9"

services:
  # ==================== BACKEND API (PRODUCTION) ====================
  backend:
    image: ghcr.io/${REGISTRY_USER}/halo-be:${BACKEND_TAG:-latest}
    container_name: halo-backend
    restart: unless-stopped
    env_file: .env
    environment:
      NODE_ENV: production
      PORT: ${BACKEND_PORT:-4000}
      MONGODB_URI: ${MONGODB_URI}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: "true"
      PUPPETEER_EXECUTABLE_PATH: /usr/bin/chromium-browser
    ports:
      - "${BACKEND_PORT:-4000}:4000"
    volumes:
      - uploads_data:/usr/src/app/uploads
    depends_on:
      mongo:
        condition: service_healthy
      redis:
        condition: service_started
    healthcheck:
      test: ["CMD", "node", "healthcheck.js"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - halo-network

  # ==================== ADMIN PANEL (STATIC NGINX) ====================
  admin-panel:
    image: ghcr.io/${REGISTRY_USER}/halo-admin:${ADMIN_TAG:-latest}
    container_name: halo-admin-panel
    restart: unless-stopped
    environment:
      # Được backend dùng để build file cấu hình runtime (nếu cần)
      API_BASE_URL: ${API_BASE_URL:-http://backend:4000}
    ports:
      - "${ADMIN_PORT:-3001}:80"
    depends_on:
      backend:
        condition: service_started
    networks:
      - halo-network

  # ==================== PUBLIC CLIENT ====================
  public:
    image: ghcr.io/${REGISTRY_USER}/halo-public:${PUBLIC_TAG:-latest}
    container_name: halo-public
    restart: unless-stopped
    environment:
      VITE_API_BASE_URL: ${API_BASE_URL:-http://backend:4000}
    ports:
      - "${PUBLIC_PORT:-3000}:80"
    depends_on:
      backend:
        condition: service_started
    networks:
      - halo-network

  # ==================== MONGODB (PRODUCTION) ====================
  mongo:
    image: mongo:6.0
    container_name: halo-mongo
    restart: unless-stopped
    command: ["--replSet", "rs0"]
    ports:
      - "${MONGO_PORT:-27017}:27017"
    environment:
      MONGO_INITDB_DATABASE: halo
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-strongpassword123}
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: ["CMD", "mongo", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - halo-network

  # ==================== REDIS (CACHE / QUEUE) ====================
  redis:
    image: redis:7-alpine
    container_name: halo-redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    networks:
      - halo-network

volumes:
  mongo_data:
    driver: local
  uploads_data:
    driver: local
  redis_data:
    driver: local

networks:
  halo-network:
    driver: bridge
